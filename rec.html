<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Travel Planner</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPnLXTOd76DE4Ks3uHbj8AOEvRh30dzlo&libraries=places" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/openweathermap-js-api@1.0.1/weather.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/rec.css') }}">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --accent-color: #e74c3c;
            --background-color: #ecf0f1;
            --text-color: #34495e;
        }
        body, html {
            height: 100%;
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        .container {
            display: grid;
            grid-template-columns: 300px 1fr;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
        }
        header {
            grid-column: 1 / -1;
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .sidebar {
            grid-column: 1 / 2;
            grid-row: 2 / 3;
            background-color: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        #map {
            grid-column: 2 / -1;
            grid-row: 2 / 3;
            height: 100%;
        }
        footer {
            grid-column: 1 / -1;
            background-color: var(--primary-color);
            color: white;
            padding: 10px;
            text-align: center;
        }
        .search-bar {
            display: flex;
            margin-bottom: 20px;
        }
        .search-bar input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px 0 0 4px;
        }
        .search-bar button {
            padding: 10px 15px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .search-bar button:hover {
            background-color: #27ae60;
        }
        .filter-options, .travel-mode {
            margin-bottom: 20px;
        }
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
        }
        .result-item {
            background-color: white;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        .result-item:hover {
            transform: translateY(-5px);
        }
        .result-item h3 {
            margin-top: 0;
            color: var(--primary-color);
        }
        .route-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .route-actions button {
            padding: 10px 15px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .route-actions button:hover {
            background-color: #c0392b;
        }
        .weather-toggle {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .weather-toggle label {
            margin-right: 10px;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--secondary-color);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            .sidebar {
                grid-column: 1 / -1;
                grid-row: auto;
            }
            #map {
                grid-column: 1 / -1;
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-globe-americas"></i> Advanced Travel Planner</h1>
        </header>

        <aside class="sidebar">
            <div class="search-bar">
                <input id="search-input" type="text" placeholder="Search places...">
                <button onclick="searchPlaces()"><i class="fas fa-search"></i></button>
            </div>

            <div class="filter-options">
                <select id="type-select">
                    <option value="">All Types</option>
                    <option value="tourist_attraction">Tourist Attractions</option>
                    <option value="restaurant">Restaurants</option>
                    <option value="lodging">Hotels</option>
                </select>
            </div>

            <div class="filter-options">
                <select id="rating-select">
                    <option value="">Any Rating</option>
                    <option value="4">4+ Stars</option>
                    <option value="3">3+ Stars</option>
                    <option value="2">2+ Stars</option>
                </select>
            </div>

            <div class="travel-mode">
                <select id="travel-mode-select" onchange="calculateShortestPath()">
                    <option value="DRIVING">Driving</option>
                    <option value="WALKING">Walking</option>
                    <option value="BICYCLING">Bicycling</option>
                    <option value="TRANSIT">Transit</option>
                </select>
            </div>
            <button onclick="calculateDistances()">Shortest path</button>
            <button onclick="clearMarkers()">clearMarkers</button>
            

            

            <div id="weather-info"></div>
            
            <div id="search-results"></div>

            <div id="result" class="result"></div>
          

            <div class="route-actions">
                <button onclick="saveRoute()"><i class="fas fa-save"></i> Save Route</button>
                <!--<button onclick="loadRoute()"><i class="fas fa-folder-open"></i> Load Route</button>-->
            </div>
            
        </aside>

        <section id="map"></section>

        <footer>
            <p>Contact Us: <a href="mailto:srianthnani09@gmail.com">srianthnani09@gmail.com</a></p>
        </footer>
    </div>
    <script src="{{ url_for('static', filename='js/rec.js') }}"></script>
    <script>
        
let map, service, directionsRenderer;
const markers = [];
let userMarker;
let weatherOverlay;

function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
        zoom: 12,
        mapTypeControl: false,
        fullscreenControl: true,
        streetViewControl: false,
        styles: [
            {
                featureType: "all",
                elementType: "labels.text.fill",
                stylers: [{ color: "#7c93a3" }, { lightness: -10 }]
            },
            {
                featureType: "administrative.country",
                elementType: "geometry",
                stylers: [{ visibility: "on" }]
            },
            {
                featureType: "landscape",
                elementType: "geometry.fill",
                stylers: [{ color: "#dde3e3" }]
            }
        ]
    });

    directionsRenderer = new google.maps.DirectionsRenderer({
        suppressMarkers: true,
        polylineOptions: {
            strokeColor: "#3498db",
            strokeWeight: 5
        }
    });
    directionsRenderer.setMap(map);

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
            const userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            map.setCenter(userLocation);

            userMarker = new google.maps.Marker({
                position: userLocation,
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: '#3498db',
                    fillOpacity: 1,
                    strokeWeight: 2,
                    strokeColor: '#ffffff'
                },
                title: 'Your Location'
            });

            navigator.geolocation.watchPosition((position) => {
                const newUserLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                userMarker.setPosition(newUserLocation);
                map.panTo(newUserLocation);
            });

        }, () => {
            handleLocationError(true, map.getCenter());
        });
    } else {
        handleLocationError(false, map.getCenter());
    }

    const input = document.getElementById('search-input');
    const autocomplete = new google.maps.places.Autocomplete(input);
    autocomplete.bindTo('bounds', map);

    autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (!place.geometry || !place.geometry.location) {
            alert("No details available for the selected place.");
            return;
        }
        map.panTo(place.geometry.location);
        map.setZoom(14);
        addMarker(place.geometry.location, place.name);
    });

    map.addListener('click', (event) => {
        addMarker(event.latLng);
    });

    createWeatherOverlay();
}

function handleLocationError(browserHasGeolocation, pos) {
    alert(browserHasGeolocation
        ? "Error: The Geolocation service failed."
        : "Error: Your browser doesn't support geolocation.");
    map.setCenter(pos);
}

function addMarker(location, title = 'Selected Location') {
    const marker = new google.maps.Marker({
        position: location,
        map: map,
        title: title,
        animation: google.maps.Animation.DROP,
        icon: {
            url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
        }
    });
    markers.push(marker);
    if (markers.length > 1) {
        calculateShortestPath();
    }
    findNearbyPlaces(location);
    getWeather(location);

    
}

function calculateShortestPath() {
    if (markers.length < 2) {
        return;
    }
    const directionsService = new google.maps.DirectionsService();
    const travelMode = document.getElementById('travel-mode-select').value;

    const waypoints = markers.slice(1, -1).map(marker => ({
        location: marker.getPosition(),
        stopover: true,
    }));

    directionsService.route({
        origin: markers[0].getPosition(),
        destination: markers[markers.length - 1].getPosition(),
        waypoints: waypoints,
        travelMode: google.maps.TravelMode[travelMode],
    }, (result, status) => {
        if (status === google.maps.DirectionsStatus.OK) {
            directionsRenderer.setDirections(result);
            displayDistanceAndDuration(result);
            updateMarkerIcons();
        } else {
            alert('Failed to calculate route: ' + status);
        }
    });
}
function calculateDistances() {
    if (markers.length < 2) {
        alert("Please select at least two places.");
        return;
    }
    
    const service = new google.maps.DistanceMatrixService();
    const origins = markers.map(marker => marker.getPosition());
    const destinations = [...origins];
    
    service.getDistanceMatrix({
        origins: origins,
        destinations: destinations,
        travelMode: google.maps.TravelMode.DRIVING,
        unitSystem: google.maps.UnitSystem.METRIC
    }, (response, status) => {
        if (status !== 'OK') {
            alert('Error was: ' + status);
            return;
        }
        
        let shortestDistance = Infinity;
        let shortestRoute = [];
        
        const permutations = getPermutations([...Array(origins.length).keys()]);
        
        permutations.forEach(perm => {
            let totalDistance = 0;
            for (let i = 0; i < perm.length - 1; i++) {
                totalDistance += response.rows[perm[i]].elements[perm[i+1]].distance.value;
            }
            if (totalDistance < shortestDistance) {
                shortestDistance = totalDistance;
                shortestRoute = perm;
            }
        });
        
        displayShortestRoute(shortestRoute, response);
    });
}

function getPermutations(arr) {
    if (arr.length <= 2) return arr.length === 2 ? [arr, [arr[1], arr[0]]] : [arr];
    return arr.reduce((acc, item, i) =>
        acc.concat(getPermutations([...arr.slice(0, i), ...arr.slice(i + 1)]).map(val => [item, ...val])),
    []);
}

function displayShortestRoute(route, response) {
    let result = "Shortest route:\n";
    let totalDistance = 0;
    let totalDuration = 0;
    
    for (let i = 0; i < route.length - 1; i++) {
        const element = response.rows[route[i]].elements[route[i+1]];
        result += `${markers[route[i]].getTitle()} to ${markers[route[i+1]].getTitle()}: ${element.distance.text}\n`;
        totalDistance += element.distance.value;
        totalDuration += element.duration.value;
    }
    
    result += `\nTotal distance: ${(totalDistance / 1000).toFixed(2)} km`;
    result += `\nEstimated total duration: ${Math.round(totalDuration / 60)} minutes`;
    
    document.getElementById('result').innerHTML = result.replace(/\n/g, '<br>');
}
function updateMarkerIcons() {
    markers.forEach((marker, index) => {
        const label = (index + 1).toString();
        marker.setIcon({
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: '#e74c3c',
            fillOpacity: 0.9,
            strokeWeight: 2,
            strokeColor: '#ffffff',
            scale: 10,
            labelOrigin: new google.maps.Point(0, 3.5)
        });
        marker.setLabel({
            text: label,
            color: '#ffffff',
            fontSize: '12px',
            fontWeight: 'bold'
        });
    });
}

function displayDistanceAndDuration(result) {
    const route = result.routes[0];
    let totalDistance = 0;
    let totalDuration = 0;

    route.legs.forEach(leg => {
        totalDistance += leg.distance.value;
        totalDuration += leg.duration.value;
    });

    totalDistance = (totalDistance / 1000).toFixed(2);
    totalDuration = (totalDuration / 60).toFixed(2);

    document.getElementById('result').innerHTML = `
        <i class="fas fa-route"></i> Total Distance: ${totalDistance} km<br>
        <i class="fas fa-clock"></i> Total Duration: ${totalDuration} mins
    `;
}

function searchPlaces() {
    const query = document.getElementById('search-input').value;
    const type = document.getElementById('type-select').value;
    const minRating = document.getElementById('rating-select').value;

    if (!query) {
        alert("Please enter a search term.");
        return;
    }

    service = new google.maps.places.PlacesService(map);
    service.textSearch({
        query: query,
        type: type,
    }, (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '';
            results.forEach(place => {
                if (place.geometry && place.geometry.location && (!minRating || place.rating >= parseFloat(minRating))) {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'result-item';
                    resultItem.innerHTML = `
                        <h3>${place.name}</h3>
                        <p><i class="fas fa-star"></i> ${place.rating ? place.rating.toFixed(1) : 'N/A'}</p>
                        <p><i class="fas fa-map-marker-alt"></i> ${place.formatted_address}</p>
                    `;
                    resultItem.addEventListener('click', () => {
                        map.panTo(place.geometry.location);
                        map.setZoom(14);
                        addMarker(place.geometry.location, place.name);
                    });
                    resultsContainer.appendChild(resultItem);
                }
            });
        } else {
            alert('Search failed: ' + status);
        }
    });
}

function saveRoute() {
    const route = markers.map(marker => ({
        lat: marker.getPosition().lat(),
        lng: marker.getPosition().lng(),
        title: marker.getTitle()
    }));
    localStorage.setItem('savedRoute', JSON.stringify(route));
    alert('Route saved successfully!');
}

function loadRoute() {
    const savedRoute = JSON.parse(localStorage.getItem('savedRoute'));
    if (savedRoute && savedRoute.length > 0) {
        clearMarkers();
        savedRoute.forEach(point => {
            addMarker(new google.maps.LatLng(point.lat, point.lng), point.title);
        });
        calculateShortestPath();
    } else {
        alert('No saved route found.');
    }
}

function clearMarkers() {
    markers.forEach(marker => marker.setMap(null));
    markers.length = 0;
    directionsRenderer.setDirections({routes: []});
}

function createWeatherOverlay() {
    weatherOverlay = new google.maps.ImageMapType({
        getTileUrl: function(coord, zoom) {
            return `https://tile.openweathermap.org/map/temp_new/${zoom}/${coord.x}/${coord.y}.png?appid=e597f0454b011ac1ad8a410141ca2ff6`;
        },
        tileSize: new google.maps.Size(256, 256),
        maxZoom: 9,
        minZoom: 0,
        name: 'Weather'
    });
}

function toggleWeather() {
    const weatherSwitch = document.getElementById('weather-switch');
    if (weatherSwitch.checked) {
        map.overlayMapTypes.push(weatherOverlay);
    } else {
        map.overlayMapTypes.clear();
    }
}

function findNearbyPlaces(location) {
    const service = new google.maps.places.PlacesService(map);
    service.nearbySearch({
        location: location,
        radius: 500,
        type: ['point_of_interest']
    }, (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
            for (let i = 0; i < Math.min(results.length, 5); i++) {
                const place = results[i];
                const marker = new google.maps.Marker({
                    position: place.geometry.location,
                    map: map,
                    title: place.name,
                    icon: {
                        url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                    }
                });
                
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div>
                            <h3>${place.name}</h3>
                            <p>${place.vicinity}</p>
                            <p>Rating: ${place.rating ? place.rating.toFixed(1) : 'N/A'}</p>
                        </div>
                    `
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });
            }
        }
    });
}

window.onload = initMap;

function getWeather(location) {
    const apiKey = 'e597f0454b011ac1ad8a410141ca2ff6'; 
    const url = `https://api.openweathermap.org/data/2.5/weather?lat=${location.lat()}&lon=${location.lng()}&appid=${apiKey}&units=metric`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            const weatherInfo = `
                <h3>Current Weather</h3>
                <p>Temperature: ${data.main.temp}°C</p>
                <p>Condition: ${data.weather[0].main}</p>
                <p>Humidity: ${data.main.humidity}%</p>
            `;
            document.getElementById('weather-info').innerHTML = weatherInfo;
        })
        .catch(error => {
            console.error('Error fetching weather:', error);
            document.getElementById('weather-info').innerHTML = 'Unable to fetch weather information.';
        });
}

map.addListener('click', (event) => {
    addMarker(event.latLng);
});

// Add a button to calculate distances
const calculateButton = document.createElement('button');
calculateButton.textContent = 'Calculate Shortest Route';
calculateButton.onclick = calculateDistances;
document.querySelector('.sidebar').appendChild(calculateButton);
    </script>
</body>
</html>